# HTM Bundled Defaults
#
# This file is the SINGLE SOURCE OF TRUTH for HTM configuration schema.
# All attributes must be declared here (even if nil) to be recognized.
# It is bundled with the gem and loaded automatically at lowest priority.
#
# Loading priority (lowest to highest):
# 1. This file (bundled defaults)
# 2. XDG user config (~/.config/htm/htm.yml)
# 3. Project config (./config/htm.yml)
# 4. Local overrides (./config/htm.local.yml)
# 5. Environment variables (HTM_*)
# 6. Programmatic (HTM.configure block)
#
# Structure:
# - defaults: Base values for all environments (with nested sections)
# - development: Overrides for development environment
# - test: Overrides for test environment
# - production: Overrides for production environment

# =============================================================================
# Shared Defaults (base for all environments)
# =============================================================================
defaults:
  # ---------------------------------------------------------------------------
  # Database Configuration
  # Access: HTM.config.database.host, HTM.config.database.port, etc.
  # ---------------------------------------------------------------------------
  database:
    url: ~
    host: localhost
    port: 5432
    name: ~
    user: ~
    password: ~
    pool_size: 10
    timeout: 5000
    sslmode: prefer

  # ---------------------------------------------------------------------------
  # Service Configuration
  # Access: HTM.config.service.name
  # ---------------------------------------------------------------------------
  service:
    name: htm

  # ---------------------------------------------------------------------------
  # Embedding Configuration
  # Access: HTM.config.embedding.provider, HTM.config.embedding.model, etc.
  # ---------------------------------------------------------------------------
  embedding:
    provider: ollama
    model: nomic-embed-text:latest
    dimensions: 768
    timeout: 120
    max_dimension: 2000

  # ---------------------------------------------------------------------------
  # Tag Extraction Configuration
  # Access: HTM.config.tag.provider, HTM.config.tag.model, etc.
  #
  # Prompt templates use %{placeholder} for runtime interpolation:
  #   %{text} - the content to extract tags from
  #   %{max_depth} - maximum tag hierarchy depth
  #   %{taxonomy_context} - existing taxonomy info or new taxonomy message
  # ---------------------------------------------------------------------------
  tag:
    provider: ollama
    model: gemma3:latest
    timeout: 180
    max_depth: 4

    system_prompt: |
      You are a taxonomy classifier that assigns texts to a hierarchical classification tree.
      Each concept has ONE canonical location in the tree.
      Output 2-5 classification paths, one per line.

    user_prompt_template: |
      Extract classification tags for this text using a HIERARCHICAL TAXONOMY.

      %{taxonomy_context}

      TAG FORMAT: domain:category:subcategory:term (colon-separated, max %{max_depth} levels)

      LEVEL GUIDELINES:
      - Level 1 (domain): Broad field (database, ai, web, security, devops)
      - Level 2 (category): Major subdivision (database:relational, ai:machine-learning)
      - Level 3 (subcategory): Specific area (database:relational:postgresql)
      - Level 4 (term): Fine detail, use sparingly (database:relational:postgresql:extensions)

      RULES:
      1. Each concept belongs to ONE path only
      2. Use lowercase, hyphens for multi-word terms
      3. ALWAYS use SINGULAR forms, never plurals (user NOT users, framework NOT frameworks, model NOT models)
      4. Return 2-5 tags that best classify this text
      5. Match existing taxonomy paths when applicable

      TEXT: %{text}

      Return ONLY tags, one per line.

    taxonomy_context_existing: "Existing taxonomy paths: %{sample_tags}\n\nPrefer reusing these paths when the text matches their domain."
    taxonomy_context_empty: "This is a new taxonomy - establish clear root categories."

  # ---------------------------------------------------------------------------
  # Proposition Extraction Configuration
  # Access: HTM.config.proposition.provider, HTM.config.proposition.model, etc.
  #
  # Prompt templates use %{placeholder} for runtime interpolation:
  #   %{text} - the content to extract propositions from
  # ---------------------------------------------------------------------------
  proposition:
    provider: ollama
    model: gemma3:latest
    timeout: 180
    enabled: true
    min_length: 10
    max_length: 1000
    min_words: 5

    system_prompt: |
      You are an atomic fact extraction system. Extract factual propositions from text.
      Output ONLY propositions, one per line, prefixed with a dash (-).
      NEVER ask for clarification or more text - extract what you can from the given text.
      If the text contains no extractable facts, output nothing.

    user_prompt_template: |
      Extract ATOMIC factual propositions from the following text.

      An atomic proposition:
      - Expresses exactly ONE fact or relationship
      - Is understandable WITHOUT any additional context
      - Uses FULL NAMES, never pronouns (he, she, it, they, this, that)
      - Contains at least 5 words for sufficient context

      PRONOUN REPLACEMENT EXAMPLES:
      BAD:  "It is important to know the enemy."
      GOOD: "Knowing the enemy is important for spiritual warfare."

      BAD:  "They support thousands of users."
      GOOD: "The Every.to products support thousands of daily users."

      BAD:  "This results in a calculation."
      GOOD: "The age calculation depends on whether the birthday has occurred."

      CONTEXT ENRICHMENT EXAMPLES:
      BAD:  "Wiring costs $1,000."
      GOOD: "Solar panel wiring costs $1,000 for the Oklahoma barndominium project."

      BAD:  "The driveway is gravel."
      GOOD: "Dewayne's barndominium driveway is gravel."

      RULES:
      1. Split compound statements into separate atomic facts
      2. Each proposition = exactly one fact
      3. Replace ALL pronouns with the actual names/nouns they refer to
      4. Include enough context to understand the fact in isolation
      5. If unsure what a pronoun refers to, omit that proposition

      TEXT: %{text}

      Return ONLY atomic propositions, one per line. Use a dash (-) prefix for each.
      If you cannot extract any facts, return nothing. Do NOT ask for more text.

  # ---------------------------------------------------------------------------
  # Chunking Configuration (for file loading)
  # Access: HTM.config.chunking.size, HTM.config.chunking.overlap
  # ---------------------------------------------------------------------------
  chunking:
    size: 1024
    overlap: 64

  # ---------------------------------------------------------------------------
  # Circuit Breaker Configuration
  # Access: HTM.config.circuit_breaker.failure_threshold, etc.
  # ---------------------------------------------------------------------------
  circuit_breaker:
    failure_threshold: 5
    reset_timeout: 60
    half_open_max_calls: 3

  # ---------------------------------------------------------------------------
  # Relevance Scoring Configuration
  # Access: HTM.config.relevance.semantic_weight, etc.
  # ---------------------------------------------------------------------------
  relevance:
    semantic_weight: 0.5
    tag_weight: 0.3
    recency_weight: 0.1
    access_weight: 0.1
    recency_half_life_hours: 168.0

  # ---------------------------------------------------------------------------
  # Job Backend Configuration
  # Access: HTM.config.job.backend
  # ---------------------------------------------------------------------------
  job:
    backend: fiber

  # ---------------------------------------------------------------------------
  # General Settings
  # Access: HTM.config.week_start, HTM.config.connection_timeout, etc.
  # ---------------------------------------------------------------------------
  week_start: sunday
  connection_timeout: 60
  telemetry_enabled: false
  log_level: info

  # ---------------------------------------------------------------------------
  # Provider Credentials
  # Access: HTM.config.providers.openai.api_key, etc.
  # ---------------------------------------------------------------------------
  providers:
    openai:
      api_key: ~
      organization: ~
      project: ~

    anthropic:
      api_key: ~

    gemini:
      api_key: ~

    azure:
      api_key: ~
      endpoint: ~
      api_version: "2024-02-01"

    ollama:
      url: http://localhost:11434

    huggingface:
      api_key: ~

    openrouter:
      api_key: ~

    bedrock:
      access_key: ~
      secret_key: ~
      region: us-east-1

    deepseek:
      api_key: ~

# =============================================================================
# Development Environment Overrides
# =============================================================================
development:
  database:
    name: htm_development
  log_level: debug

# =============================================================================
# Test Environment Overrides
# =============================================================================
test:
  database:
    name: htm_test
  job:
    backend: inline
  log_level: warn
  telemetry_enabled: false

# =============================================================================
# Production Environment Overrides
# =============================================================================
production:
  database:
    pool_size: 25
    sslmode: require
  log_level: warn
  telemetry_enabled: true
