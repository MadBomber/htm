<svg viewBox="0 0 1000 800" xmlns="http://www.w3.org/2000/svg" style="background: transparent;">
  <!-- Title -->
  <text x="500" y="30" text-anchor="middle" fill="#FFFFFF" font-size="20" font-weight="bold">Memory Addition Flow (Client-Side Embedding Generation)</text>

  <!-- User -->
  <rect x="50" y="80" width="180" height="60" fill="rgba(76, 175, 80, 0.3)" stroke="#4CAF50" stroke-width="3" rx="8"/>
  <text x="140" y="115" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">User: add_message</text>

  <!-- HTM -->
  <rect x="280" y="80" width="140" height="60" fill="rgba(33, 150, 243, 0.3)" stroke="#2196F3" stroke-width="3" rx="8"/>
  <text x="350" y="115" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">HTM</text>

  <!-- EmbeddingService -->
  <rect x="470" y="80" width="190" height="60" fill="rgba(255, 152, 0, 0.3)" stroke="#FF9800" stroke-width="3" rx="8"/>
  <text x="565" y="115" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">EmbeddingService</text>

  <!-- Ollama/OpenAI -->
  <rect x="710" y="80" width="180" height="60" fill="rgba(255, 193, 7, 0.3)" stroke="#FFC107" stroke-width="3" rx="8"/>
  <text x="800" y="115" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">Ollama/OpenAI</text>

  <!-- LongTermMemory -->
  <rect x="280" y="260" width="180" height="60" fill="rgba(156, 39, 176, 0.3)" stroke="#9C27B0" stroke-width="3" rx="8"/>
  <text x="370" y="295" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">LongTermMemory</text>

  <!-- PostgreSQL -->
  <rect x="510" y="260" width="140" height="60" fill="rgba(156, 39, 176, 0.3)" stroke="#9C27B0" stroke-width="3" rx="8"/>
  <text x="580" y="295" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">PostgreSQL</text>

  <!-- WorkingMemory -->
  <rect x="280" y="420" width="180" height="60" fill="rgba(33, 150, 243, 0.3)" stroke="#2196F3" stroke-width="3" rx="8"/>
  <text x="370" y="455" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">WorkingMemory</text>

  <!-- Flow arrows and labels -->
  <!-- 1. Request -->
  <path d="M 230 110 L 280 110" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrowGreen)"/>
  <text x="255" y="105" text-anchor="middle" fill="#4CAF50" font-size="11">1. Request</text>

  <!-- 2. Count tokens -->
  <path d="M 350 140 L 490 140 L 490 135" stroke="#FF9800" stroke-width="2" fill="none" marker-end="url(#arrowOrange)"/>
  <text x="420" y="135" text-anchor="middle" fill="#FF9800" font-size="11">2. Count tokens</text>

  <!-- 3. Return count -->
  <path d="M 535 135 L 535 160 L 350 160 L 350 145" stroke="#FF9800" stroke-width="2" fill="none" marker-end="url(#arrowOrange)"/>
  <text x="440" y="155" text-anchor="middle" fill="#FF9800" font-size="11">3. Return count</text>

  <!-- 4. Generate embedding -->
  <path d="M 420 110 L 470 110" stroke="#FF9800" stroke-width="2" fill="none" marker-end="url(#arrowOrange)"/>
  <text x="445" y="105" text-anchor="middle" fill="#FF9800" font-size="11">4. Generate</text>

  <!-- 5. HTTP call -->
  <path d="M 660 110 L 710 110" stroke="#FFC107" stroke-width="2" fill="none" marker-end="url(#arrowYellow)"/>
  <text x="685" y="105" text-anchor="middle" fill="#FFC107" font-size="11">5. HTTP call</text>

  <!-- 6. Return vector -->
  <path d="M 800 140 L 800 180 L 565 180 L 565 145" stroke="#FFC107" stroke-width="2" fill="none" marker-end="url(#arrowYellow)"/>
  <text x="680" y="175" text-anchor="middle" fill="#FFC107" font-size="11">6. Return vector</text>

  <!-- 7. Return embedding -->
  <path d="M 540 140 L 540 200 L 350 200 L 350 145" stroke="#FF9800" stroke-width="2" fill="none" marker-end="url(#arrowOrange)"/>
  <text x="445" y="195" text-anchor="middle" fill="#FF9800" font-size="11">7. Return embedding</text>

  <!-- 8. Persist with embedding -->
  <path d="M 350 145 L 350 260" stroke="#9C27B0" stroke-width="2" fill="none" marker-end="url(#arrowPurple)"/>
  <text x="300" y="210" text-anchor="middle" fill="#9C27B0" font-size="11">8. Persist with</text>
  <text x="300" y="225" text-anchor="middle" fill="#9C27B0" font-size="11">embedding</text>

  <!-- 9. INSERT with embedding -->
  <path d="M 460 290 L 510 290" stroke="#9C27B0" stroke-width="2" fill="none" marker-end="url(#arrowPurple)"/>
  <text x="485" y="285" text-anchor="middle" fill="#9C27B0" font-size="11">9. INSERT</text>

  <!-- 10. Return node_id -->
  <path d="M 580 260 L 580 240 L 370 240 L 370 255" stroke="#9C27B0" stroke-width="2" fill="none" marker-end="url(#arrowPurple)"/>
  <text x="475" y="235" text-anchor="middle" fill="#9C27B0" font-size="11">10. Return node_id</text>

  <!-- 11. Return node_id -->
  <path d="M 340 260 L 340 230 L 350 230 L 350 220 L 350 145" stroke="#2196F3" stroke-width="2" fill="none" marker-end="url(#arrowBlue)"/>
  <text x="250" y="235" text-anchor="middle" fill="#2196F3" font-size="11">11. node_id</text>

  <!-- 12. Check space -->
  <path d="M 350 230 L 350 340 L 320 340 L 320 420" stroke="#2196F3" stroke-width="2" fill="none" marker-end="url(#arrowBlue)"/>
  <text x="280" y="375" text-anchor="middle" fill="#2196F3" font-size="11">12. Check</text>
  <text x="280" y="390" text-anchor="middle" fill="#2196F3" font-size="11">space</text>

  <!-- Decision diamond -->
  <polygon points="370,500 420,450 470,500 420,550" fill="rgba(255, 193, 7, 0.3)" stroke="#FFC107" stroke-width="3"/>
  <text x="420" y="505" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">Has</text>
  <text x="420" y="520" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">Space?</text>

  <!-- No path - Evict -->
  <rect x="520" y="470" width="140" height="60" fill="rgba(244, 67, 54, 0.3)" stroke="#F44336" stroke-width="3" rx="8"/>
  <text x="590" y="505" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">Evict nodes</text>

  <path d="M 470 500 L 520 500" stroke="#F44336" stroke-width="2" fill="none" marker-end="url(#arrowRed)"/>
  <text x="495" y="495" text-anchor="middle" fill="#F44336" font-size="11">No</text>

  <!-- 14. Mark evicted -->
  <path d="M 590 470 L 590 340 L 370 340 L 370 320" stroke="#F44336" stroke-width="2" fill="none" marker-end="url(#arrowRed)"/>
  <text x="480" y="335" text-anchor="middle" fill="#F44336" font-size="11">14. Mark evicted</text>

  <!-- Yes path -->
  <rect x="280" y="600" width="180" height="60" fill="rgba(76, 175, 80, 0.3)" stroke="#4CAF50" stroke-width="3" rx="8"/>
  <text x="370" y="635" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">Add to WM</text>

  <path d="M 420 550 L 420 600" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrowGreen)"/>
  <text x="435" y="580" text-anchor="middle" fill="#4CAF50" font-size="11">Yes</text>

  <path d="M 590 530 L 590 630 L 460 630" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrowGreen)"/>

  <!-- 15. Success -->
  <path d="M 280 630 L 230 630 L 230 110" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrowGreen)"/>
  <text x="200" y="375" text-anchor="middle" fill="#4CAF50" font-size="11">15. Success</text>

  <!-- 17. Return node_id -->
  <text x="200" y="140" text-anchor="middle" fill="#4CAF50" font-size="11">17. Return</text>
  <text x="200" y="155" text-anchor="middle" fill="#4CAF50" font-size="11">node_id</text>

  <!-- Markers -->
  <defs>
    <marker id="arrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#4CAF50"/>
    </marker>
    <marker id="arrowBlue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#2196F3"/>
    </marker>
    <marker id="arrowOrange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#FF9800"/>
    </marker>
    <marker id="arrowYellow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#FFC107"/>
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#9C27B0"/>
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#F44336"/>
    </marker>
  </defs>
</svg>
