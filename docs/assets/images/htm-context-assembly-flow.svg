<svg viewBox="0 0 900 650" xmlns="http://www.w3.org/2000/svg" style="background: transparent;">
  <!-- Title -->
  <text x="450" y="30" text-anchor="middle" fill="#FFFFFF" font-size="20" font-weight="bold">Context Assembly Flow</text>

  <!-- User -->
  <rect x="50" y="80" width="200" height="60" fill="rgba(76, 175, 80, 0.3)" stroke="#4CAF50" stroke-width="3" rx="8"/>
  <text x="150" y="110" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">User: create_context</text>
  <text x="150" y="128" text-anchor="middle" fill="#B0B0B0" font-size="11">(with strategy)</text>

  <!-- HTM -->
  <rect x="300" y="80" width="140" height="60" fill="rgba(33, 150, 243, 0.3)" stroke="#2196F3" stroke-width="3" rx="8"/>
  <text x="370" y="115" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">HTM</text>

  <!-- WorkingMemory -->
  <rect x="490" y="80" width="160" height="60" fill="rgba(33, 150, 243, 0.3)" stroke="#2196F3" stroke-width="3" rx="8"/>
  <text x="570" y="115" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">WorkingMemory</text>

  <!-- Strategy Diamond -->
  <polygon points="570,210 620,160 670,210 620,260" fill="rgba(255, 193, 7, 0.3)" stroke="#FFC107" stroke-width="3"/>
  <text x="620" y="210" text-anchor="middle" fill="#FFFFFF" font-size="12" font-weight="bold">Strategy</text>
  <text x="620" y="225" text-anchor="middle" fill="#FFFFFF" font-size="12" font-weight="bold">Type?</text>

  <!-- Recent Strategy -->
  <rect x="720" y="140" width="150" height="60" fill="rgba(103, 58, 183, 0.3)" stroke="#673AB7" stroke-width="3" rx="8"/>
  <text x="795" y="165" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">Sort by access</text>
  <text x="795" y="185" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">order (:recent)</text>

  <!-- Important Strategy -->
  <rect x="720" y="220" width="150" height="60" fill="rgba(244, 67, 54, 0.3)" stroke="#F44336" stroke-width="3" rx="8"/>
  <text x="795" y="245" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">Sort by</text>
  <text x="795" y="265" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">importance</text>

  <!-- Balanced Strategy -->
  <rect x="720" y="300" width="150" height="60" fill="rgba(76, 175, 80, 0.3)" stroke="#4CAF50" stroke-width="3" rx="8"/>
  <text x="795" y="325" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">Hybrid score</text>
  <text x="795" y="345" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">(:balanced)</text>

  <!-- Sorted nodes -->
  <rect x="580" y="410" width="140" height="60" fill="rgba(156, 39, 176, 0.3)" stroke="#9C27B0" stroke-width="3" rx="8"/>
  <text x="650" y="445" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">Sorted nodes</text>

  <!-- Token budget loop -->
  <rect x="350" y="410" width="180" height="60" fill="rgba(255, 152, 0, 0.3)" stroke="#FF9800" stroke-width="3" rx="8"/>
  <text x="440" y="445" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">Token budget loop</text>

  <!-- Token check Diamond -->
  <polygon points="300,540 350,490 400,540 350,590" fill="rgba(255, 193, 7, 0.3)" stroke="#FFC107" stroke-width="3"/>
  <text x="350" y="540" text-anchor="middle" fill="#FFFFFF" font-size="11" font-weight="bold">Tokens</text>
  <text x="350" y="555" text-anchor="middle" fill="#FFFFFF" font-size="11" font-weight="bold">&lt; max?</text>

  <!-- Add node -->
  <rect x="480" y="510" width="140" height="60" fill="rgba(76, 175, 80, 0.3)" stroke="#4CAF50" stroke-width="3" rx="8"/>
  <text x="550" y="535" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">Add node to</text>
  <text x="550" y="555" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">context</text>

  <!-- Stop -->
  <rect x="140" y="510" width="150" height="60" fill="rgba(244, 67, 54, 0.3)" stroke="#F44336" stroke-width="3" rx="8"/>
  <text x="215" y="535" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">Stop, return</text>
  <text x="215" y="555" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">context</text>

  <!-- Final context -->
  <rect x="190" y="300" width="200" height="60" fill="rgba(76, 175, 80, 0.3)" stroke="#4CAF50" stroke-width="3" rx="8"/>
  <text x="290" y="325" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">Assembled context</text>
  <text x="290" y="345" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">string</text>

  <!-- Flow arrows -->
  <!-- 1. Request -->
  <path d="M 250 110 L 300 110" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrowG)"/>
  <text x="275" y="105" text-anchor="middle" fill="#4CAF50" font-size="11">1. Request</text>

  <!-- 2. Assemble -->
  <path d="M 440 110 L 490 110" stroke="#2196F3" stroke-width="2" fill="none" marker-end="url(#arrowB)"/>
  <text x="465" y="105" text-anchor="middle" fill="#2196F3" font-size="11">2. Assemble</text>

  <!-- 3. Strategy -->
  <path d="M 570 140 L 570 160 L 590 160 L 590 190 L 620 190" stroke="#FFC107" stroke-width="2" fill="none" marker-end="url(#arrowY)"/>
  <text x="545" y="165" text-anchor="middle" fill="#FFC107" font-size="11">3. Strategy?</text>

  <!-- Strategy paths -->
  <path d="M 670 175 L 720 170" stroke="#673AB7" stroke-width="2" fill="none" marker-end="url(#arrowP)"/>
  <text x="695" y="165" text-anchor="middle" fill="#673AB7" font-size="10">:recent</text>

  <path d="M 670 210 L 720 210 L 720 250" stroke="#F44336" stroke-width="2" fill="none" marker-end="url(#arrowR)"/>
  <text x="695" y="215" text-anchor="middle" fill="#F44336" font-size="10">:important</text>

  <path d="M 670 245 L 720 245 L 720 330" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrowG)"/>
  <text x="695" y="260" text-anchor="middle" fill="#4CAF50" font-size="10">:balanced</text>

  <!-- To sorted nodes -->
  <path d="M 795 200 L 795 375 L 650 375 L 650 410" stroke="#9C27B0" stroke-width="2" fill="none" marker-end="url(#arrowPu)"/>
  <path d="M 795 280 L 795 375" stroke="#9C27B0" stroke-width="2" fill="none"/>
  <path d="M 795 360 L 795 375" stroke="#9C27B0" stroke-width="2" fill="none"/>

  <!-- 4. Build context -->
  <path d="M 580 440 L 530 440" stroke="#FF9800" stroke-width="2" fill="none" marker-end="url(#arrowO)"/>
  <text x="555" y="435" text-anchor="middle" fill="#FF9800" font-size="11">4. Build</text>

  <!-- 5. Check tokens -->
  <path d="M 410 470 L 410 490 L 380 490 L 380 520 L 350 520 L 350 540" stroke="#FFC107" stroke-width="2" fill="none" marker-end="url(#arrowY)"/>
  <text x="385" y="495" text-anchor="middle" fill="#FFC107" font-size="11">5. Check</text>

  <!-- Yes path -->
  <path d="M 400 540 L 480 540" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrowG)"/>
  <text x="440" y="535" text-anchor="middle" fill="#4CAF50" font-size="11">Yes</text>

  <!-- Loop back -->
  <path d="M 550 570 L 550 595 L 440 595 L 440 470" stroke="#2196F3" stroke-width="2" fill="none" marker-end="url(#arrowB)"/>

  <!-- No path -->
  <path d="M 300 540 L 290 540" stroke="#F44336" stroke-width="2" fill="none" marker-end="url(#arrowR)"/>
  <text x="295" y="535" text-anchor="middle" fill="#F44336" font-size="11">No</text>

  <!-- 6. Join nodes -->
  <path d="M 215 510 L 215 385 L 290 385 L 290 360" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrowG)"/>
  <text x="170" y="460" text-anchor="middle" fill="#4CAF50" font-size="11">6. Join</text>
  <text x="170" y="475" text-anchor="middle" fill="#4CAF50" font-size="11">nodes</text>

  <!-- 7-9 Return path -->
  <path d="M 290 300 L 290 260 L 370 260 L 370 140" stroke="#2196F3" stroke-width="2" fill="none" marker-end="url(#arrowB)"/>
  <text x="250" y="275" text-anchor="middle" fill="#2196F3" font-size="11">7-9. Return</text>

  <path d="M 370 80 L 370 65 L 150 65 L 150 80" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrowG)"/>

  <!-- Markers -->
  <defs>
    <marker id="arrowG" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#4CAF50"/>
    </marker>
    <marker id="arrowB" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#2196F3"/>
    </marker>
    <marker id="arrowO" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#FF9800"/>
    </marker>
    <marker id="arrowY" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#FFC107"/>
    </marker>
    <marker id="arrowPu" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#9C27B0"/>
    </marker>
    <marker id="arrowP" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#673AB7"/>
    </marker>
    <marker id="arrowR" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#F44336"/>
    </marker>
  </defs>
</svg>
