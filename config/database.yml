# HTM Database Configuration
# Uses ERB to read from environment variables
#
# Priority:
# 1. HTM_DBURL - Full connection URL (preferred for development/production)
# 2. Individual HTM_DB* variables - Host, name, user, password, port
# 3. Defaults for development/test
#
# Example HTM_DBURL format:
#   postgresql://user:password@host:port/database?sslmode=require
#
# Environment detection priority:
#   HTM_ENV > RAILS_ENV > RACK_ENV > 'development'
#
# Test database:
#   Tests always use htm_test database.
#   Set HTM_ENV=test (or RAILS_ENV=test) to use the test configuration.

<%
  require 'uri'

  # Determine current environment (HTM_ENV takes priority for non-Rails users)
  current_env = ENV['HTM_ENV'] || ENV['RAILS_ENV'] || ENV['RACK_ENV'] || 'development'

  # Parse connection from HTM_DBURL or use individual variables
  if ENV['HTM_DBURL']
    uri = URI.parse(ENV['HTM_DBURL'])
    params = URI.decode_www_form(uri.query || '').to_h
    base_database = uri.path[1..-1]

    # Extract base name (remove _development, _test, _production suffixes if present)
    base_name = base_database.sub(/_(development|test|production)$/, '')

    db_config = {
      'host' => uri.host,
      'port' => uri.port || 5432,
      'base_name' => base_name,
      'username' => uri.user,
      'password' => uri.password,
      'sslmode' => params['sslmode'] || 'prefer'
    }
  else
    db_config = {
      'host' => ENV.fetch('HTM_DBHOST', 'localhost'),
      'port' => ENV.fetch('HTM_DBPORT', 5432).to_i,
      'base_name' => ENV.fetch('HTM_DBNAME', 'htm').sub(/_(development|test|production)$/, ''),
      'username' => ENV.fetch('HTM_DBUSER', ENV['USER']),
      'password' => ENV.fetch('HTM_DBPASS', ''),
      'sslmode' => ENV.fetch('HTM_SSLMODE', 'prefer')
    }
  end
%>

default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("HTM_DB_POOL_SIZE", "10").to_i %>
  timeout: 5000
  prepared_statements: false
  advisory_locks: false
  host: <%= db_config['host'] %>
  port: <%= db_config['port'] %>
  username: <%= db_config['username'] %>
  password: <%= db_config['password'] %>
  sslmode: <%= db_config['sslmode'] %>

development:
  <<: *default
  database: <%= db_config['base_name'] %>_development

test:
  <<: *default
  database: <%= db_config['base_name'] %>_test

production:
  <<: *default
  database: <%= db_config['base_name'] %>_production
