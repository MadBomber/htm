<svg viewBox="0 0 1200 900" xmlns="http://www.w3.org/2000/svg" style="background: transparent;">
  <!-- Title -->
  <text x="600" y="30" text-anchor="middle" fill="#FFFFFF" font-size="22" font-weight="bold">Complete Memory Flow: Add → State → Recall</text>

  <!-- Section 1: Add Memory -->
  <rect x="30" y="60" width="380" height="360" fill="rgba(33, 150, 243, 0.1)" stroke="#2196F3" stroke-width="2" rx="8" stroke-dasharray="10,5"/>
  <text x="220" y="85" text-anchor="middle" fill="#2196F3" font-size="16" font-weight="bold">1. Add Memory</text>

  <!-- User: add_node -->
  <rect x="120" y="110" width="200" height="50" fill="rgba(76, 175, 80, 0.3)" stroke="#4CAF50" stroke-width="3" rx="8"/>
  <text x="220" y="140" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">User: add_node()</text>

  <!-- Generate embedding -->
  <rect x="120" y="190" width="200" height="50" fill="rgba(33, 150, 243, 0.3)" stroke="#2196F3" stroke-width="3" rx="8"/>
  <text x="220" y="220" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">Generate embedding</text>

  <!-- Store in LTM -->
  <rect x="120" y="270" width="200" height="50" fill="rgba(156, 39, 176, 0.3)" stroke="#9C27B0" stroke-width="3" rx="8"/>
  <text x="220" y="300" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">Store in LTM</text>

  <!-- Decision: WM has space? -->
  <polygon points="220,390 270,350 320,390 270,430" fill="rgba(255, 193, 7, 0.3)" stroke="#FFC107" stroke-width="3"/>
  <text x="270" y="385" text-anchor="middle" fill="#FFFFFF" font-size="12" font-weight="bold">WM has</text>
  <text x="270" y="402" text-anchor="middle" fill="#FFFFFF" font-size="12" font-weight="bold">space?</text>

  <!-- Evict from WM -->
  <rect x="50" y="470" width="130" height="50" fill="rgba(244, 67, 54, 0.3)" stroke="#F44336" stroke-width="3" rx="8"/>
  <text x="115" y="500" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">Evict from WM</text>

  <!-- Mark evicted in LTM -->
  <rect x="50" y="550" width="130" height="50" fill="rgba(156, 39, 176, 0.3)" stroke="#9C27B0" stroke-width="3" rx="8"/>
  <text x="115" y="575" text-anchor="middle" fill="#FFFFFF" font-size="12" font-weight="bold">Mark evicted</text>
  <text x="115" y="590" text-anchor="middle" fill="#FFFFFF" font-size="12" font-weight="bold">in LTM</text>

  <!-- Add to WM -->
  <rect x="260" y="470" width="130" height="50" fill="rgba(76, 175, 80, 0.3)" stroke="#4CAF50" stroke-width="3" rx="8"/>
  <text x="325" y="500" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">Add to WM</text>

  <!-- Arrows for Add Memory flow -->
  <path d="M 220 160 L 220 190" stroke="#2196F3" stroke-width="2" fill="none" marker-end="url(#arrow1)"/>
  <path d="M 220 240 L 220 270" stroke="#9C27B0" stroke-width="2" fill="none" marker-end="url(#arrow2)"/>
  <path d="M 220 320 L 220 350" stroke="#FFC107" stroke-width="2" fill="none" marker-end="url(#arrow3)"/>

  <!-- Yes path -->
  <path d="M 270 430 L 270 450 L 325 450 L 325 470" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrow4)"/>
  <text x="285" y="445" text-anchor="start" fill="#4CAF50" font-size="11" font-weight="bold">Yes</text>

  <!-- No path -->
  <path d="M 220 390 L 180 390 L 180 465 L 115 465 L 115 470" stroke="#F44336" stroke-width="2" fill="none" marker-end="url(#arrow5)"/>
  <text x="160" y="385" text-anchor="end" fill="#F44336" font-size="11" font-weight="bold">No</text>

  <path d="M 115 520 L 115 550" stroke="#9C27B0" stroke-width="2" fill="none" marker-end="url(#arrow2)"/>
  <path d="M 115 600 L 115 640 L 325 640 L 325 520" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrow4)"/>

  <!-- Section 2: Memory States -->
  <rect x="460" y="60" width="280" height="360" fill="rgba(255, 193, 7, 0.1)" stroke="#FFC107" stroke-width="2" rx="8" stroke-dasharray="10,5"/>
  <text x="600" y="85" text-anchor="middle" fill="#FFC107" font-size="16" font-weight="bold">2. Memory States</text>

  <!-- In Both Memories -->
  <rect x="480" y="470" width="220" height="80" fill="rgba(255, 193, 7, 0.3)" stroke="#FFC107" stroke-width="3" rx="8"/>
  <text x="590" y="500" text-anchor="middle" fill="#FFFFFF" font-size="15" font-weight="bold">In Both Memories</text>
  <text x="590" y="520" text-anchor="middle" fill="#B0B0B0" font-size="11">(Working + Long-Term)</text>
  <text x="590" y="538" text-anchor="middle" fill="#B0B0B0" font-size="11">Fast access + Persistent</text>

  <!-- In LTM Only -->
  <rect x="480" y="580" width="220" height="80" fill="rgba(156, 39, 176, 0.3)" stroke="#9C27B0" stroke-width="3" rx="8"/>
  <text x="590" y="610" text-anchor="middle" fill="#FFFFFF" font-size="15" font-weight="bold">In LTM Only</text>
  <text x="590" y="630" text-anchor="middle" fill="#B0B0B0" font-size="11">(Evicted from WM)</text>
  <text x="590" y="648" text-anchor="middle" fill="#B0B0B0" font-size="11">Persistent storage only</text>

  <!-- Arrows to states -->
  <path d="M 390 495 L 480 510" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrow4)"/>
  <path d="M 180 620 L 400 620 L 400 700 L 590 700 L 590 660" stroke="#9C27B0" stroke-width="2" fill="none" marker-end="url(#arrow2)"/>

  <!-- Section 3: Recall Memory -->
  <rect x="790" y="60" width="380" height="360" fill="rgba(156, 39, 176, 0.1)" stroke="#9C27B0" stroke-width="2" rx="8" stroke-dasharray="10,5"/>
  <text x="980" y="85" text-anchor="middle" fill="#9C27B0" font-size="16" font-weight="bold">3. Recall Memory</text>

  <!-- User: recall -->
  <rect x="880" y="110" width="200" height="50" fill="rgba(33, 150, 243, 0.3)" stroke="#2196F3" stroke-width="3" rx="8"/>
  <text x="980" y="140" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">User: recall()</text>

  <!-- RAG Search in LTM -->
  <rect x="880" y="190" width="200" height="50" fill="rgba(156, 39, 176, 0.3)" stroke="#9C27B0" stroke-width="3" rx="8"/>
  <text x="980" y="220" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">RAG Search in LTM</text>

  <!-- Results found -->
  <rect x="880" y="270" width="200" height="50" fill="rgba(76, 175, 80, 0.3)" stroke="#4CAF50" stroke-width="3" rx="8"/>
  <text x="980" y="300" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">Results found</text>

  <!-- Decision: WM has space? -->
  <polygon points="980,390 1030,350 1080,390 1030,430" fill="rgba(255, 193, 7, 0.3)" stroke="#FFC107" stroke-width="3"/>
  <text x="1030" y="385" text-anchor="middle" fill="#FFFFFF" font-size="12" font-weight="bold">WM has</text>
  <text x="1030" y="402" text-anchor="middle" fill="#FFFFFF" font-size="12" font-weight="bold">space?</text>

  <!-- Evict from WM (recall) -->
  <rect x="810" y="470" width="130" height="50" fill="rgba(244, 67, 54, 0.3)" stroke="#F44336" stroke-width="3" rx="8"/>
  <text x="875" y="500" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">Evict from WM</text>

  <!-- Add to WM (recall) -->
  <rect x="1020" y="470" width="130" height="50" fill="rgba(76, 175, 80, 0.3)" stroke="#4CAF50" stroke-width="3" rx="8"/>
  <text x="1085" y="500" text-anchor="middle" fill="#FFFFFF" font-size="13" font-weight="bold">Add to WM</text>

  <!-- Arrows for Recall flow -->
  <path d="M 980 160 L 980 190" stroke="#9C27B0" stroke-width="2" fill="none" marker-end="url(#arrow2)"/>
  <path d="M 980 240 L 980 270" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrow4)"/>
  <path d="M 980 320 L 980 350" stroke="#FFC107" stroke-width="2" fill="none" marker-end="url(#arrow3)"/>

  <!-- Yes path (recall) -->
  <path d="M 1030 430 L 1030 450 L 1085 450 L 1085 470" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrow4)"/>
  <text x="1045" y="445" text-anchor="start" fill="#4CAF50" font-size="11" font-weight="bold">Yes</text>

  <!-- No path (recall) -->
  <path d="M 980 390 L 940 390 L 940 465 L 875 465 L 875 470" stroke="#F44336" stroke-width="2" fill="none" marker-end="url(#arrow5)"/>
  <text x="920" y="385" text-anchor="end" fill="#F44336" font-size="11" font-weight="bold">No</text>

  <path d="M 875 520 L 875 640 L 1085 640 L 1085 520" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrow4)"/>

  <!-- Connection to In Both Memories -->
  <path d="M 1020 495 L 840 495 L 840 510 L 700 510" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrow4)"/>

  <!-- Dotted lines for recall and already loaded -->
  <path d="M 700 620 L 760 620 L 760 135 L 880 135" stroke="#9C27B0" stroke-width="2" fill="none" stroke-dasharray="5,5" marker-end="url(#arrow2)"/>
  <text x="770" y="375" text-anchor="start" fill="#9C27B0" font-size="11" font-style="italic">recall</text>

  <!-- Return from WM -->
  <rect x="480" y="760" width="220" height="60" fill="rgba(76, 175, 80, 0.3)" stroke="#4CAF50" stroke-width="3" rx="8"/>
  <text x="590" y="795" text-anchor="middle" fill="#FFFFFF" font-size="14" font-weight="bold">Return from WM</text>

  <path d="M 590 550 L 590 680 L 420 680 L 420 790 L 480 790" stroke="#4CAF50" stroke-width="2" fill="none" stroke-dasharray="5,5" marker-end="url(#arrow4)"/>
  <text x="430" y="735" text-anchor="start" fill="#4CAF50" font-size="11" font-style="italic">already loaded</text>

  <!-- Notes -->
  <rect x="30" y="720" width="380" height="150" fill="rgba(33, 150, 243, 0.1)" stroke="#2196F3" stroke-width="2" rx="5" stroke-dasharray="5,5"/>
  <text x="220" y="745" text-anchor="middle" fill="#2196F3" font-size="13" font-weight="bold">Key Concepts</text>
  <text x="40" y="770" fill="#B0B0B0" font-size="11">• <tspan fill="#4CAF50" font-weight="bold">Green paths</tspan>: Successful operations</text>
  <text x="40" y="790" fill="#B0B0B0" font-size="11">• <tspan fill="#F44336" font-weight="bold">Red paths</tspan>: Eviction required (no space)</text>
  <text x="40" y="810" fill="#B0B0B0" font-size="11">• <tspan fill="#FFC107" font-weight="bold">Yellow states</tspan>: Both memories (optimal)</text>
  <text x="40" y="830" fill="#B0B0B0" font-size="11">• <tspan fill="#9C27B0" font-weight="bold">Purple states</tspan>: LTM only (evicted)</text>
  <text x="40" y="850" fill="#B0B0B0" font-size="11">• <tspan fill="#2196F3" font-weight="bold">Dotted lines</tspan>: Conditional flows</text>

  <!-- Markers -->
  <defs>
    <marker id="arrow1" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#2196F3"/>
    </marker>
    <marker id="arrow2" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#9C27B0"/>
    </marker>
    <marker id="arrow3" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#FFC107"/>
    </marker>
    <marker id="arrow4" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#4CAF50"/>
    </marker>
    <marker id="arrow5" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#F44336"/>
    </marker>
  </defs>
</svg>
